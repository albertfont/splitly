{% extends 'base.html' %}
{% block content %}
<div class="container">
  <h2 class="my-4">Resum de l'event: "{{ event.name }}"</h2>
  <div class="row">
  <div class="col-md-6 mb-4">
    <h4 class="mt-4">Balanç per participant</h4>

    <div class="mt-4" style="max-height: 300px; overflow-y: auto;">
      <canvas id="balanceChart"></canvas>
    </div>
  </div>
  <div class="col-md-6 mb-4">
    <h4 class="mt-5">Transferències recomanades</h4>
    <br>
    {% if transfers %}
      <ul class="list-group">
      {% for t in transfers %}
        <li class="list-group-item">
          <i class="fas fa-exchange-alt text-primary me-1"></i>
          <b>{{ t.from }}</b> hauria de pagar <b>{{ t.amount }} €</b> a <b>{{ t.to }}</b>
        </li>
      {% endfor %}
      </ul>
    {% else %}
      <div class="alert alert-success mt-3">
        No hi ha transferències necessàries. El balanç està equilibrat.
      </div>
    {% endif %}
  </div>
  </div>
  <div class="col-md-6 mb-4">
    <h4 class="mt-4">Gestio de l'event</h4>
    <p>Arxivar l'event un cop ja esta finalitzat i ja s'han realitzat tots els pagaments entre els participants. Un cop arxivat l'event no es podrà recuperar.</p>
    <form method="POST" action="{{ url_for('archive_event', event_token=event.token) }}" class="d-inline">
      <button class="btn btn-sm btn-outline-danger" type="submit"
              onclick="return confirm('Segur que vols arxivar aquest event?')">
        <i class="fas fa-trash-alt"></i>Arxivar
      </button>
    </form>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  const ctx = document.getElementById('balanceChart').getContext('2d');

  const data = {
    labels: {{ chart_data | map(attribute='name') | list | tojson }},
    datasets: [{
      label: 'Balanç (€)',
      data: {{ chart_data | map(attribute='balance') | list | tojson }},
      backgroundColor: {{ chart_data | map(attribute='balance') | map('float') | list | tojson }}.map(b => b >= 0 ? 'rgba(25, 135, 84, 0.6)' : 'rgba(220, 53, 69, 0.6)'),
      borderColor: {{ chart_data | map(attribute='balance') | map('float') | list | tojson }}.map(b => b >= 0 ? 'rgba(25, 135, 84, 1)' : 'rgba(220, 53, 69, 1)'),
      borderWidth: 1,
      barThickness: 30
    }]
  };

  new Chart(ctx, {
    type: 'bar',
    data: data,
    options: {
      indexAxis: 'y',
      scales: {
        x: {
          beginAtZero: true
        }
      }
    }
  });
</script>

{% endblock %}
